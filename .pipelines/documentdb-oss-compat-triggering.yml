trigger:
  branches:
    include:
      - "users/yangqiao/AddTriggeringPipeline"

pool:
  vmImage: 'ubuntu-latest'

stages:  
- stage: TriggerCompatTestPipeline  
  displayName: "Extract Source Branch Name"  
  jobs:  
  - job: TriggerCompatTest  
    steps:  
    - powershell: |  
        $body = '
        { 
                "definition": {
                    "id": 45276
                },
                "templateParameters": {
                  "sourceBranch": "$(Build.SourceBranch)",
                  "sourceCommit": "$(Build.SourceVersion)"
              }
        }
        '
        Write-Host $body
        $personalToken = "$(System.AccessToken)"
        $token =   [System.Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes(":$($personalToken)"))
        $header = @{authorization = "Basic $token"}
        $Uri = "https://dev.azure.com/$(INTERNAL_ORGANIZATION)/$(System.TeamProject)/_apis/build/builds?api-version=7.1"
        Write-Host $Uri
        $buildresponse = Invoke-RestMethod -Method Post -ContentType "application/json" -Uri $Uri -Body $body -Headers $header
        Write-Host $buildresponse
      displayName: "TriggerCompatTest"  
  
- stage: MonitorCompatPipeline  
  displayName: "Monitor Compat Pipeline"  
  dependsOn: TriggerCompatTestPipeline  
  jobs:  
  - job: MonitorCompatJob  
    steps:  
    - script: |  
         echo "BuildId: $(Build.BuildId)"
      displayName: "MonitorCompatJob"  